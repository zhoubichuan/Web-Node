<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1.为什么要做前端监控 | JavaScript笔记</title>
    <meta name="description" content="个人总结的vuepress学习技术文档-语法">
    <script src="https://cdn.jsdelivr.net/npm/react/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <link rel="icon" href="/Web-Node/favicon.ico">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="msapplication-TileColor" content="#000000">
    <meta name="keywords" content="vuepress,最新技术文档,vuepress语法,markdown语法">
    <link rel="preload" href="/Web-Node/assets/css/0.styles.dca708c7.css" as="style"><link rel="preload" href="/Web-Node/assets/js/app.3f8e6221.js" as="script"><link rel="preload" href="/Web-Node/assets/js/136.d1ddb140.js" as="script"><link rel="prefetch" href="/Web-Node/assets/js/10.bcbdedf2.js"><link rel="prefetch" href="/Web-Node/assets/js/100.f6b12536.js"><link rel="prefetch" href="/Web-Node/assets/js/101.93c6c50d.js"><link rel="prefetch" href="/Web-Node/assets/js/102.553488df.js"><link rel="prefetch" href="/Web-Node/assets/js/103.75e90cde.js"><link rel="prefetch" href="/Web-Node/assets/js/104.82fda765.js"><link rel="prefetch" href="/Web-Node/assets/js/105.ba2c3e75.js"><link rel="prefetch" href="/Web-Node/assets/js/106.626facfa.js"><link rel="prefetch" href="/Web-Node/assets/js/107.ebef0a88.js"><link rel="prefetch" href="/Web-Node/assets/js/108.f686e1a7.js"><link rel="prefetch" href="/Web-Node/assets/js/109.ee32c66f.js"><link rel="prefetch" href="/Web-Node/assets/js/11.e347bbcb.js"><link rel="prefetch" href="/Web-Node/assets/js/110.fc2b8c84.js"><link rel="prefetch" href="/Web-Node/assets/js/111.6e912d00.js"><link rel="prefetch" href="/Web-Node/assets/js/112.42119ca0.js"><link rel="prefetch" href="/Web-Node/assets/js/113.c2f233c7.js"><link rel="prefetch" href="/Web-Node/assets/js/114.e7a86ce9.js"><link rel="prefetch" href="/Web-Node/assets/js/115.1972b873.js"><link rel="prefetch" href="/Web-Node/assets/js/116.d9daf171.js"><link rel="prefetch" href="/Web-Node/assets/js/117.3f5606aa.js"><link rel="prefetch" href="/Web-Node/assets/js/118.1e9b095b.js"><link rel="prefetch" href="/Web-Node/assets/js/119.8d006863.js"><link rel="prefetch" href="/Web-Node/assets/js/12.3fc6bdeb.js"><link rel="prefetch" href="/Web-Node/assets/js/120.44e54f56.js"><link rel="prefetch" href="/Web-Node/assets/js/121.5a3a01b1.js"><link rel="prefetch" href="/Web-Node/assets/js/122.196e304e.js"><link rel="prefetch" href="/Web-Node/assets/js/123.2e8031f8.js"><link rel="prefetch" href="/Web-Node/assets/js/124.05914df9.js"><link rel="prefetch" href="/Web-Node/assets/js/125.655a5454.js"><link rel="prefetch" href="/Web-Node/assets/js/126.f452e22d.js"><link rel="prefetch" href="/Web-Node/assets/js/127.51a928e6.js"><link rel="prefetch" href="/Web-Node/assets/js/128.0c4ab3f4.js"><link rel="prefetch" href="/Web-Node/assets/js/129.e757d553.js"><link rel="prefetch" href="/Web-Node/assets/js/13.945779d7.js"><link rel="prefetch" href="/Web-Node/assets/js/130.b4428332.js"><link rel="prefetch" href="/Web-Node/assets/js/131.781c5920.js"><link rel="prefetch" href="/Web-Node/assets/js/132.b3a6f9e0.js"><link rel="prefetch" href="/Web-Node/assets/js/133.438ac740.js"><link rel="prefetch" href="/Web-Node/assets/js/134.e679d205.js"><link rel="prefetch" href="/Web-Node/assets/js/135.02d11976.js"><link rel="prefetch" href="/Web-Node/assets/js/137.af69275d.js"><link rel="prefetch" href="/Web-Node/assets/js/138.d41cf352.js"><link rel="prefetch" href="/Web-Node/assets/js/139.41a99bcf.js"><link rel="prefetch" href="/Web-Node/assets/js/14.789f64d9.js"><link rel="prefetch" href="/Web-Node/assets/js/140.73d5ecd3.js"><link rel="prefetch" href="/Web-Node/assets/js/141.5e5dbd43.js"><link rel="prefetch" href="/Web-Node/assets/js/142.a92682c9.js"><link rel="prefetch" href="/Web-Node/assets/js/143.9d4760b9.js"><link rel="prefetch" href="/Web-Node/assets/js/144.5ff2dcc8.js"><link rel="prefetch" href="/Web-Node/assets/js/145.3b4b4197.js"><link rel="prefetch" href="/Web-Node/assets/js/146.43f00c7c.js"><link rel="prefetch" href="/Web-Node/assets/js/147.ffd2feb8.js"><link rel="prefetch" href="/Web-Node/assets/js/148.44d5f4c7.js"><link rel="prefetch" href="/Web-Node/assets/js/149.dc8d51a7.js"><link rel="prefetch" href="/Web-Node/assets/js/15.269cc528.js"><link rel="prefetch" href="/Web-Node/assets/js/150.d983d318.js"><link rel="prefetch" href="/Web-Node/assets/js/151.9731aa70.js"><link rel="prefetch" href="/Web-Node/assets/js/152.b872494f.js"><link rel="prefetch" href="/Web-Node/assets/js/153.e84eb35b.js"><link rel="prefetch" href="/Web-Node/assets/js/154.9e11aecc.js"><link rel="prefetch" href="/Web-Node/assets/js/155.1c81b6db.js"><link rel="prefetch" href="/Web-Node/assets/js/16.1c494600.js"><link rel="prefetch" href="/Web-Node/assets/js/17.7323a6f1.js"><link rel="prefetch" href="/Web-Node/assets/js/18.d7474c22.js"><link rel="prefetch" href="/Web-Node/assets/js/19.ffedbce8.js"><link rel="prefetch" href="/Web-Node/assets/js/2.f3095994.js"><link rel="prefetch" href="/Web-Node/assets/js/20.36f9dc66.js"><link rel="prefetch" href="/Web-Node/assets/js/21.d3cbf4e3.js"><link rel="prefetch" href="/Web-Node/assets/js/22.7429e70e.js"><link rel="prefetch" href="/Web-Node/assets/js/23.4dd6db5c.js"><link rel="prefetch" href="/Web-Node/assets/js/24.c4b66709.js"><link rel="prefetch" href="/Web-Node/assets/js/25.d0384634.js"><link rel="prefetch" href="/Web-Node/assets/js/26.4688db93.js"><link rel="prefetch" href="/Web-Node/assets/js/27.c83928bc.js"><link rel="prefetch" href="/Web-Node/assets/js/28.ec1eb6e7.js"><link rel="prefetch" href="/Web-Node/assets/js/29.e47f6b5d.js"><link rel="prefetch" href="/Web-Node/assets/js/3.7ba0e909.js"><link rel="prefetch" href="/Web-Node/assets/js/30.bb4152e9.js"><link rel="prefetch" href="/Web-Node/assets/js/31.e41bbae6.js"><link rel="prefetch" href="/Web-Node/assets/js/32.7724aeb6.js"><link rel="prefetch" href="/Web-Node/assets/js/33.80359b3b.js"><link rel="prefetch" href="/Web-Node/assets/js/34.197a3382.js"><link rel="prefetch" href="/Web-Node/assets/js/35.03d1c772.js"><link rel="prefetch" href="/Web-Node/assets/js/36.9c0e346f.js"><link rel="prefetch" href="/Web-Node/assets/js/37.58a13553.js"><link rel="prefetch" href="/Web-Node/assets/js/38.d3762e2e.js"><link rel="prefetch" href="/Web-Node/assets/js/39.ad7401e0.js"><link rel="prefetch" href="/Web-Node/assets/js/4.f57ad261.js"><link rel="prefetch" href="/Web-Node/assets/js/40.c7d0ea21.js"><link rel="prefetch" href="/Web-Node/assets/js/41.8b6b5854.js"><link rel="prefetch" href="/Web-Node/assets/js/42.a3e58719.js"><link rel="prefetch" href="/Web-Node/assets/js/43.a4017144.js"><link rel="prefetch" href="/Web-Node/assets/js/44.414f4633.js"><link rel="prefetch" href="/Web-Node/assets/js/45.00586e9c.js"><link rel="prefetch" href="/Web-Node/assets/js/46.481640fe.js"><link rel="prefetch" href="/Web-Node/assets/js/47.4455414e.js"><link rel="prefetch" href="/Web-Node/assets/js/48.4d25539f.js"><link rel="prefetch" href="/Web-Node/assets/js/49.b4809994.js"><link rel="prefetch" href="/Web-Node/assets/js/5.277dafe4.js"><link rel="prefetch" href="/Web-Node/assets/js/50.8369f71c.js"><link rel="prefetch" href="/Web-Node/assets/js/51.6ffa102f.js"><link rel="prefetch" href="/Web-Node/assets/js/52.0ad399c4.js"><link rel="prefetch" href="/Web-Node/assets/js/53.c0e2a8b0.js"><link rel="prefetch" href="/Web-Node/assets/js/54.e51423c6.js"><link rel="prefetch" href="/Web-Node/assets/js/55.3eee815a.js"><link rel="prefetch" href="/Web-Node/assets/js/56.ad221357.js"><link rel="prefetch" href="/Web-Node/assets/js/57.edfc5cee.js"><link rel="prefetch" href="/Web-Node/assets/js/58.996cbef4.js"><link rel="prefetch" href="/Web-Node/assets/js/59.437c9d28.js"><link rel="prefetch" href="/Web-Node/assets/js/6.5c54a787.js"><link rel="prefetch" href="/Web-Node/assets/js/60.ba7a010e.js"><link rel="prefetch" href="/Web-Node/assets/js/61.07c0e915.js"><link rel="prefetch" href="/Web-Node/assets/js/62.468c0219.js"><link rel="prefetch" href="/Web-Node/assets/js/63.ddd50a89.js"><link rel="prefetch" href="/Web-Node/assets/js/64.9c1b5a81.js"><link rel="prefetch" href="/Web-Node/assets/js/65.8be0d160.js"><link rel="prefetch" href="/Web-Node/assets/js/66.26a7e307.js"><link rel="prefetch" href="/Web-Node/assets/js/67.83f49a3f.js"><link rel="prefetch" href="/Web-Node/assets/js/68.ce69e648.js"><link rel="prefetch" href="/Web-Node/assets/js/69.cc747c02.js"><link rel="prefetch" href="/Web-Node/assets/js/7.66b4ea27.js"><link rel="prefetch" href="/Web-Node/assets/js/70.237cf84b.js"><link rel="prefetch" href="/Web-Node/assets/js/71.a05514f5.js"><link rel="prefetch" href="/Web-Node/assets/js/72.c8058260.js"><link rel="prefetch" href="/Web-Node/assets/js/73.b981fd34.js"><link rel="prefetch" href="/Web-Node/assets/js/74.5f5c91ae.js"><link rel="prefetch" href="/Web-Node/assets/js/75.ed4cf607.js"><link rel="prefetch" href="/Web-Node/assets/js/76.d2c908bd.js"><link rel="prefetch" href="/Web-Node/assets/js/77.316cc7c1.js"><link rel="prefetch" href="/Web-Node/assets/js/78.51366828.js"><link rel="prefetch" href="/Web-Node/assets/js/79.4a7f7b41.js"><link rel="prefetch" href="/Web-Node/assets/js/8.d9738dc8.js"><link rel="prefetch" href="/Web-Node/assets/js/80.1df726ad.js"><link rel="prefetch" href="/Web-Node/assets/js/81.4f0355cf.js"><link rel="prefetch" href="/Web-Node/assets/js/82.83bd45fb.js"><link rel="prefetch" href="/Web-Node/assets/js/83.2643997d.js"><link rel="prefetch" href="/Web-Node/assets/js/84.6b887fe4.js"><link rel="prefetch" href="/Web-Node/assets/js/85.2d7365f6.js"><link rel="prefetch" href="/Web-Node/assets/js/86.d364d1c3.js"><link rel="prefetch" href="/Web-Node/assets/js/87.a2586737.js"><link rel="prefetch" href="/Web-Node/assets/js/88.a090aa35.js"><link rel="prefetch" href="/Web-Node/assets/js/89.6ed702fe.js"><link rel="prefetch" href="/Web-Node/assets/js/9.9fc74723.js"><link rel="prefetch" href="/Web-Node/assets/js/90.e07752c6.js"><link rel="prefetch" href="/Web-Node/assets/js/91.10815d7b.js"><link rel="prefetch" href="/Web-Node/assets/js/92.6c0ae2e7.js"><link rel="prefetch" href="/Web-Node/assets/js/93.d155541f.js"><link rel="prefetch" href="/Web-Node/assets/js/94.016dd221.js"><link rel="prefetch" href="/Web-Node/assets/js/95.5c2f637b.js"><link rel="prefetch" href="/Web-Node/assets/js/96.3c83ed06.js"><link rel="prefetch" href="/Web-Node/assets/js/97.02c5ebb5.js"><link rel="prefetch" href="/Web-Node/assets/js/98.6ca46a1c.js"><link rel="prefetch" href="/Web-Node/assets/js/99.09f3ff10.js">
    <link rel="stylesheet" href="/Web-Node/assets/css/0.styles.dca708c7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Web-Node/" class="home-link router-link-active"><!----> <span class="site-name">JavaScript笔记</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Web-Node/base/stack/1.dataType.html" class="nav-link">一、堆栈内存和闭包作用域</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/base/oop/1.objectOriented.html" class="nav-link">二、面向对象程序设计</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/base/3.browser/1.browser.html" class="nav-link">三、浏览器渲染机制</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/base/dom/1.event.html" class="nav-link">四、DOM事件及设计模式</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/base/es6/1.let.html" class="nav-link">五、ES6+核心源码分析</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/base/http/1.http.html" class="nav-link">六、AJAX/HTTP数据通信</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">专项知识</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Web-Node/senior/performance/1.CDN.html" class="nav-link">一、前端性能优化</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/typeScript/15.api.html" class="nav-link">二、TypeScript</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/monitor/13.jiankong.html" class="nav-link">三、前端监控</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/security/1.xss.html" class="nav-link">四、安全防范</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/security/1.xss.html" class="nav-link">五、文件上传下载</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/h5/skill.html" class="nav-link">六、移动端开发</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">阅读书籍</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Web-Node/senior/book1/1.preparation.html" class="nav-link">一、Node.js 开发指南</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/vuex.html" class="nav-link">二、了不起的 Node.js</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/vue-router.html" class="nav-link">三、Node.js 实战</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/element/Pagination.html" class="nav-link">四、深入浅出 Node.js</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Web-Node/base/stack/1.dataType.html" class="nav-link">一、堆栈内存和闭包作用域</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/base/oop/1.objectOriented.html" class="nav-link">二、面向对象程序设计</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/base/3.browser/1.browser.html" class="nav-link">三、浏览器渲染机制</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/base/dom/1.event.html" class="nav-link">四、DOM事件及设计模式</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/base/es6/1.let.html" class="nav-link">五、ES6+核心源码分析</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/base/http/1.http.html" class="nav-link">六、AJAX/HTTP数据通信</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">专项知识</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Web-Node/senior/performance/1.CDN.html" class="nav-link">一、前端性能优化</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/typeScript/15.api.html" class="nav-link">二、TypeScript</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/monitor/13.jiankong.html" class="nav-link">三、前端监控</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/security/1.xss.html" class="nav-link">四、安全防范</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/security/1.xss.html" class="nav-link">五、文件上传下载</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/h5/skill.html" class="nav-link">六、移动端开发</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">阅读书籍</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Web-Node/senior/book1/1.preparation.html" class="nav-link">一、Node.js 开发指南</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/vuex.html" class="nav-link">二、了不起的 Node.js</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/vue-router.html" class="nav-link">三、Node.js 实战</a></li><li class="dropdown-item"><!----> <a href="/Web-Node/senior/element/Pagination.html" class="nav-link">四、深入浅出 Node.js</a></li></ul></div></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content"><h2 id="_1-为什么要做前端监控"><a href="#_1-为什么要做前端监控" class="header-anchor">#</a> 1.为什么要做前端监控</h2> <p>更快发现问题和解决问题</p> <p>做产品的决策依据</p> <p>提升前端工程师的技术深度和广度,打造简历亮点</p> <p>为业务扩展提供了更多可能性</p> <h2 id="_2-前端监控目标"><a href="#_2-前端监控目标" class="header-anchor">#</a> 2.前端监控目标</h2> <h3 id="_2-1-稳定性-stability"><a href="#_2-1-稳定性-stability" class="header-anchor">#</a> 2.1 稳定性(stability)</h3> <p>|-|-|
错误名称| 备注
JS 错误| JS 执行错误或者 promise 异常
资源异常| script、link 等资源加载异常
接口错误| ajax 或 fetch 请求接口异常
白屏| 页面空白</p> <h3 id="_2-2-用户体验-experience"><a href="#_2-2-用户体验-experience" class="header-anchor">#</a> 2.2 用户体验(experience)</h3> <p>|-|-|
错误名称| 备注
加载时间| 各个阶段的加载时间
TTFB(time to first byte)(首字节时间)| 是指浏览器发起第一个请求到数据返回第一个字节所消耗的时间，这个时间包含了网络请求时间、后端处理时间
FP(First Paint)(首次绘制)| 首次绘制包括了任何用户自定义的背景绘制，它是将第一个像素点绘制到屏幕的时刻
FCP(First Content Paint)(首次内容绘制) 首次内容绘制是浏览器将第一个 DOM 渲染到屏幕的时间,可以是任何文本、图像、SVG 等的时间
FMP(First Meaningful paint)(首次有意义绘制)| 首次有意义绘制是页面可用性的量度标准
FID(First Input Delay)(首次输入延迟)| 用户首次和页面交互到页面响应交互的时间
卡顿| 超过 50ms 的长任务</p> <h3 id="_2-3-业务-business"><a href="#_2-3-业务-business" class="header-anchor">#</a> 2.3 业务(business)</h3> <p>|-|-||
错误名称| 备注
PV| page view 即页面浏览量或点击量
UV| 指访问某个站点的不同 IP 地址的人数
页面的停留时间| 用户在每一个页面的停留时间</p> <h2 id="_3-前端监控流程"><a href="#_3-前端监控流程" class="header-anchor">#</a> 3.前端监控流程</h2> <p>前端埋点</p> <p>数据上报</p> <p>分析和计算 将采集到的数据进行加工汇总</p> <p>可视化展示 将数据按各种维度进行展示</p> <p>监控报警 发现问题后按一定的条件触发报警</p> <p>monitorplatform</p> <h3 id="_3-1-常见的埋点方案"><a href="#_3-1-常见的埋点方案" class="header-anchor">#</a> 3.1 常见的埋点方案</h3> <h4 id="_3-1-1-代码埋点"><a href="#_3-1-1-代码埋点" class="header-anchor">#</a> 3.1.1 代码埋点</h4> <p>代码埋点，就是以嵌入代码的形式进行埋点,比如需要监控用户的点击事件,会选择在用户点击时,插入一段代码，保存这个监听行为或者直接将监听行为以某一种数据格式直接传递给服务器端
优点是可以在任意时刻，精确的发送或保存所需要的数据信息
缺点是工作量较大</p> <h4 id="_3-1-2-可视化埋点"><a href="#_3-1-2-可视化埋点" class="header-anchor">#</a> 3.1.2 可视化埋点</h4> <p>通过可视化交互的手段，代替代码埋点
将业务代码和埋点代码分离，提供一个可视化交互的页面，输入为业务代码，通过这个可视化系统，可以在业务代码中自定义的增加埋点事件等等,最后输出的代码耦合了业务代码和埋点代码
可视化埋点其实是用系统来代替手工插入埋点代码</p> <h4 id="_3-1-3-无痕埋点"><a href="#_3-1-3-无痕埋点" class="header-anchor">#</a> 3.1.3 无痕埋点</h4> <p>前端的任意一个事件都被绑定一个标识，所有的事件都别记录下来
通过定期上传记录文件,配合文件解析，解析出来我们想要的数据，并生成可视化报告供专业人员分析
无痕埋点的优点是采集全量数据,不会出现漏埋和误埋等现象
缺点是给数据传输和服务器增加压力，也无法灵活定制数据结构</p> <h2 id="_4-编写监控采集脚本"><a href="#_4-编写监控采集脚本" class="header-anchor">#</a> 4.编写监控采集脚本</h2> <h3 id="_4-1-开通日志服务"><a href="#_4-1-开通日志服务" class="header-anchor">#</a> 4.1 开通日志服务</h3> <p>日志服务(Log Service,简称 SLS)是针对日志类数据一站式服务，用户无需开发就能快捷完成数据采集、消费、投递以及查询分析等功能，帮助提升运维、运营效率，建立 DT 时代海量日志处理能力
日志服务帮助文档
Web Tracking</p> <h3 id="_4-2-监控错误"><a href="#_4-2-监控错误" class="header-anchor">#</a> 4.2 监控错误</h3> <h4 id="_4-2-1-错误分类"><a href="#_4-2-1-错误分类" class="header-anchor">#</a> 4.2.1 错误分类</h4> <p>JS 错误</p> <p>JS 错误</p> <p>Promise 异常</p> <p>资源异常</p> <p>监听 error</p> <h4 id="_4-2-2-数据结构设计"><a href="#_4-2-2-数据结构设计" class="header-anchor">#</a> 4.2.2 数据结构设计</h4> <ol><li>jsError</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span><span class="token comment">//页面标题</span>
  <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span><span class="token comment">//页面URL</span>
  <span class="token string">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590815288710&quot;</span><span class="token punctuation">,</span><span class="token comment">//访问时间戳</span>
  <span class="token string">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Chrome&quot;</span><span class="token punctuation">,</span><span class="token comment">//用户浏览器类型</span>
  <span class="token string">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span><span class="token comment">//大类</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class="token comment">//小类</span>
  <span class="token string">&quot;errorType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jsError&quot;</span><span class="token punctuation">,</span><span class="token comment">//错误类型</span>
  <span class="token string">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Uncaught TypeError: Cannot set property 'error' of undefined&quot;</span><span class="token punctuation">,</span><span class="token comment">//类型详情</span>
  <span class="token string">&quot;filename&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span><span class="token comment">//访问的文件名</span>
  <span class="token string">&quot;position&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0:0&quot;</span><span class="token punctuation">,</span><span class="token comment">//行列信息</span>
  <span class="token string">&quot;stack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;btnClick (http://localhost:8080/:20:39)^HTMLInputElement.onclick (http://localhost:8080/:14:72)&quot;</span><span class="token punctuation">,</span><span class="token comment">//堆栈信息</span>
  <span class="token string">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HTML BODY #container .content INPUT&quot;</span><span class="token comment">//选择器</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ol start="2"><li>promiseError</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span><span class="token comment">//页面标题</span>
  <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span><span class="token comment">//页面URL</span>
  <span class="token string">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590815290600&quot;</span><span class="token punctuation">,</span><span class="token comment">//访问时间戳</span>
  <span class="token string">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Chrome&quot;</span><span class="token punctuation">,</span><span class="token comment">//用户浏览器类型</span>
  <span class="token string">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span><span class="token comment">//大类</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class="token comment">//小类</span>
  <span class="token string">&quot;errorType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;promiseError&quot;</span><span class="token punctuation">,</span><span class="token comment">//错误类型</span>
  <span class="token string">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;someVar is not defined&quot;</span><span class="token punctuation">,</span><span class="token comment">//类型详情</span>
  <span class="token string">&quot;filename&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span><span class="token comment">//访问的文件名</span>
  <span class="token string">&quot;position&quot;</span><span class="token operator">:</span> <span class="token string">&quot;24:29&quot;</span><span class="token punctuation">,</span><span class="token comment">//行列信息</span>
  <span class="token string">&quot;stack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/:24:29^new Promise (&lt;anonymous&gt;)^btnPromiseClick (http://localhost:8080/:23:13)^HTMLInputElement.onclick (http://localhost:8080/:15:86)&quot;</span><span class="token punctuation">,</span><span class="token comment">//堆栈信息</span>
  <span class="token string">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HTML BODY #container .content INPUT&quot;</span><span class="token comment">//选择器</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ol start="3"><li>resourceError</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span><span class="token comment">//页面标题</span>
  <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span><span class="token comment">//页面URL</span>
  <span class="token string">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590816168643&quot;</span><span class="token punctuation">,</span><span class="token comment">//访问时间戳</span>
  <span class="token string">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Chrome&quot;</span><span class="token punctuation">,</span><span class="token comment">//用户浏览器类型</span>
  <span class="token string">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span><span class="token comment">//大类</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class="token comment">//小类</span>
  <span class="token string">&quot;errorType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;resourceError&quot;</span><span class="token punctuation">,</span><span class="token comment">//错误类型</span>
  <span class="token string">&quot;filename&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/error.js&quot;</span><span class="token punctuation">,</span><span class="token comment">//访问的文件名</span>
  <span class="token string">&quot;tagName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SCRIPT&quot;</span><span class="token punctuation">,</span><span class="token comment">//标签名</span>
  <span class="token string">&quot;timeStamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;76&quot;</span><span class="token punctuation">,</span><span class="token comment">//时间</span>
  <span class="token string">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HTML BODY SCRIPT&quot;</span><span class="token comment">//选择器</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_4-2-3-报表"><a href="#_4-2-3-报表" class="header-anchor">#</a> 4.2.3 报表</h4> <p>查询语句</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">*</span> <span class="token operator">|</span> <span class="token constant">SELECT</span> kind<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> number <span class="token constant">GROUP</span> <span class="token constant">BY</span> kind
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_4-2-4-实现"><a href="#_4-2-4-实现" class="header-anchor">#</a> 4.2.4 实现</h4> <ol><li>webpack.config.js</li></ol> <p>webpack.config.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;html-webpack-plugin&quot;</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">,</span>
  context<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  entry<span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">&quot;monitor.js&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
    contentBase<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      template<span class="token operator">:</span> <span class="token string">&quot;./src/index.html&quot;</span><span class="token punctuation">,</span>
      inject<span class="token operator">:</span> <span class="token string">&quot;head&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ol start="2"><li>index.html</li></ol> <p>src\index.html</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>monitor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>点击抛出错误<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btnClick()<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
          <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>点击抛出promise错误<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btnPromiseClick()<span class="token punctuation">&quot;</span></span>
        <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">function</span> <span class="token function">btnClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span>someVariable<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token string">&quot;someVariable&quot;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">function</span> <span class="token function">btnPromiseClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>someVar<span class="token punctuation">.</span>some<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>error.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><ol start="3"><li>src\index.js
src\index.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token string">&quot;./monitor&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="4"><li>monitor\index.js
src\monitor\index.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> injectJsError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./lib/jsError&quot;</span>
<span class="token function">injectJsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="5"><li>jsError.js
src\monitor\lib\jsError.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> tracker <span class="token keyword">from</span> <span class="token string">&quot;../util/tracker&quot;</span>
<span class="token keyword">import</span> getLastEvent <span class="token keyword">from</span> <span class="token string">&quot;../util/getLastEvent&quot;</span>
<span class="token keyword">import</span> getSelector <span class="token keyword">from</span> <span class="token string">&quot;../util/getSelector&quot;</span>
<span class="token keyword">import</span> formatTime <span class="token keyword">from</span> <span class="token string">&quot;../util/formatTime&quot;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">injectJsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//一般JS运行时错误使用window.onerror捕获处理</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
    <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> lastEvent <span class="token operator">=</span> <span class="token function">getLastEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>target <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>src <span class="token operator">||</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token comment">//资源加载错误</span>
          kind<span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span> <span class="token comment">//稳定性指标</span>
          type<span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token comment">//resource</span>
          errorType<span class="token operator">:</span> <span class="token string">&quot;resourceError&quot;</span><span class="token punctuation">,</span>
          filename<span class="token operator">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>src <span class="token operator">||</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>href<span class="token punctuation">,</span> <span class="token comment">//加载失败的资源</span>
          tagName<span class="token operator">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span> <span class="token comment">//标签名</span>
          timeStamp<span class="token operator">:</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>timeStamp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//时间</span>
          selector<span class="token operator">:</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>path <span class="token operator">||</span> event<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//选择器</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          kind<span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span> <span class="token comment">//稳定性指标</span>
          type<span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token comment">//error</span>
          errorType<span class="token operator">:</span> <span class="token string">&quot;jsError&quot;</span><span class="token punctuation">,</span> <span class="token comment">//jsError</span>
          message<span class="token operator">:</span> event<span class="token punctuation">.</span>message<span class="token punctuation">,</span> <span class="token comment">//报错信息</span>
          filename<span class="token operator">:</span> event<span class="token punctuation">.</span>filename<span class="token punctuation">,</span> <span class="token comment">//报错链接</span>
          position<span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>lineNo <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>columnNo <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//行列号</span>
          stack<span class="token operator">:</span> <span class="token function">getLines</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>error<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//错误堆栈</span>
          selector<span class="token operator">:</span> lastEvent
            <span class="token operator">?</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>lastEvent<span class="token punctuation">.</span>path <span class="token operator">||</span> lastEvent<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token comment">//CSS选择器</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token boolean">true</span>
  <span class="token punctuation">)</span> <span class="token comment">// true代表在捕获阶段调用,false代表在冒泡阶段捕获,使用true或false都可以</span>

  <span class="token comment">//当Promise 被 reject 且没有 reject 处理器的时候，会触发 unhandledrejection 事件</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
    <span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> lastEvent <span class="token operator">=</span> <span class="token function">getLastEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
      <span class="token keyword">let</span> line <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">let</span> column <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
      <span class="token keyword">let</span> stack <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> event<span class="token punctuation">.</span>reason <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        message <span class="token operator">=</span> event<span class="token punctuation">.</span>reason
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> event<span class="token punctuation">.</span>reason <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        message <span class="token operator">=</span> event<span class="token punctuation">.</span>reason<span class="token punctuation">.</span>message
      <span class="token punctuation">}</span>
      <span class="token keyword">let</span> reason <span class="token operator">=</span> event<span class="token punctuation">.</span>reason
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> reason <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reason<span class="token punctuation">.</span>stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> matchResult <span class="token operator">=</span> reason<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">at\s+(.+):(\d+):(\d+)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>matchResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            file <span class="token operator">=</span> matchResult<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            line <span class="token operator">=</span> matchResult<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
            column <span class="token operator">=</span> matchResult<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
          stack <span class="token operator">=</span> <span class="token function">getLines</span><span class="token punctuation">(</span>reason<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">//未捕获的promise错误</span>
        kind<span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span> <span class="token comment">//稳定性指标</span>
        type<span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token comment">//jsError</span>
        errorType<span class="token operator">:</span> <span class="token string">&quot;promiseError&quot;</span><span class="token punctuation">,</span> <span class="token comment">//unhandledrejection</span>
        message<span class="token operator">:</span> message<span class="token punctuation">,</span> <span class="token comment">//标签名</span>
        filename<span class="token operator">:</span> file<span class="token punctuation">,</span>
        position<span class="token operator">:</span> line <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> column<span class="token punctuation">,</span> <span class="token comment">//行列</span>
        stack<span class="token punctuation">,</span>
        selector<span class="token operator">:</span> lastEvent
          <span class="token operator">?</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>lastEvent<span class="token punctuation">.</span>path <span class="token operator">||</span> lastEvent<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
          <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token boolean">true</span>
  <span class="token punctuation">)</span> <span class="token comment">// true代表在捕获阶段调用,false代表在冒泡阶段捕获,使用true或false都可以</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getLines</span><span class="token punctuation">(</span><span class="token parameter">stack</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> stack
    <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s+at\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;^&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><ol start="6"><li>formatTime.js
src\monitor\util\formatTime.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>time<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="7"><li>getLastEvent.js
src\monitor\util\getLastEvent.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> lastEvent
<span class="token punctuation">;</span><span class="token punctuation">[</span>
  <span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;pointerdown&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;touchstart&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;mousedown&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;keydown&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;mouseover&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
    event<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      lastEvent <span class="token operator">=</span> event
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      capture<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//capture 控制监听器是在捕获阶段执行还是在冒泡阶段执行</span>
      passive<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//passive 的意思是顺从的，表示它不会对事件的默认行为说 no</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> lastEvent
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ol start="8"><li>getSelector.js
src\monitor\util\getSelector.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">getSelector</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> path
    <span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> element <span class="token operator">!==</span> window <span class="token operator">&amp;&amp;</span> element <span class="token operator">!==</span> document
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> selector
      <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        selector <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>className <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>className <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        selector <span class="token operator">=</span>
          <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span>
          element<span class="token punctuation">.</span>className
            <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>item
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        selector <span class="token operator">=</span> element<span class="token punctuation">.</span>nodeName
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> selector
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">pathsOrTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>pathsOrTarget<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>pathsOrTarget<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">var</span> element <span class="token operator">=</span> pathsOrTarget
    <span class="token keyword">while</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      paths<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
      element <span class="token operator">=</span> element<span class="token punctuation">.</span>parentNode
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>paths<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><ol start="9"><li>tracker.js
src\monitor\util\tracker.js</li></ol> <p>PutWebtracking</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> host <span class="token operator">=</span> <span class="token string">&quot;cn-beijing.log.aliyuncs.com&quot;</span>
<span class="token keyword">let</span> project <span class="token operator">=</span> <span class="token string">&quot;zhufengmonitor&quot;</span>
<span class="token keyword">let</span> logstore <span class="token operator">=</span> <span class="token string">&quot;zhufengmonitor-store&quot;</span>
<span class="token keyword">var</span> userAgent <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;user-agent&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">getExtraData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> document<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
    url<span class="token operator">:</span> location<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
    timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    userAgent<span class="token operator">:</span> userAgent<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">SendTracker</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>project<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/logstores/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>logstore<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/track</span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> extraData <span class="token operator">=</span> <span class="token function">getExtraData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> logs <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>extraData<span class="token punctuation">,</span> <span class="token operator">...</span>data <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> logs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> logs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> logs<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>logs<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>logs<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      __logs__<span class="token operator">:</span> <span class="token punctuation">[</span>logs<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json;charset=UTF-8&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;x-log-apiversion&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0.6.0&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;x-log-bodyrawsize&quot;</span><span class="token punctuation">,</span> body<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">&lt;=</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">SendTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h3 id="_4-3-接口异常采集脚本"><a href="#_4-3-接口异常采集脚本" class="header-anchor">#</a> 4.3.接口异常采集脚本</h3> <h4 id="_4-3-1-数据设计"><a href="#_4-3-1-数据设计" class="header-anchor">#</a> 4.3.1 数据设计</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span> <span class="token comment">//标题</span>
  <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span> <span class="token comment">//url</span>
  <span class="token string">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590817024490&quot;</span><span class="token punctuation">,</span> <span class="token comment">//timestamp</span>
  <span class="token string">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Chrome&quot;</span><span class="token punctuation">,</span> <span class="token comment">//浏览器版本</span>
  <span class="token string">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span> <span class="token comment">//大类</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xhr&quot;</span><span class="token punctuation">,</span> <span class="token comment">//小类</span>
  <span class="token string">&quot;eventType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span> <span class="token comment">//事件类型</span>
  <span class="token string">&quot;pathname&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/success&quot;</span><span class="token punctuation">,</span> <span class="token comment">//路径</span>
  <span class="token string">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;200-OK&quot;</span><span class="token punctuation">,</span> <span class="token comment">//状态码</span>
  <span class="token string">&quot;duration&quot;</span><span class="token operator">:</span> <span class="token string">&quot;7&quot;</span><span class="token punctuation">,</span> <span class="token comment">//持续时间</span>
  <span class="token string">&quot;response&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{\&quot;id\&quot;:1}&quot;</span><span class="token punctuation">,</span> <span class="token comment">//响应内容</span>
  <span class="token string">&quot;params&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>  <span class="token comment">//参数</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590817025617&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Chrome&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xhr&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;eventType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;pathname&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/error&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;500-Internal Server Error&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;duration&quot;</span><span class="token operator">:</span> <span class="token string">&quot;7&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;response&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;params&quot;</span><span class="token operator">:</span> <span class="token string">&quot;name=zhufeng&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_4-3-2-实现"><a href="#_4-3-2-实现" class="header-anchor">#</a> 4.3.2 实现</h4> <ol><li>src\index.html</li></ol> <p>src\index.html</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>monitor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        +
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
          <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>发起ajax成功请求<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sendAjaxSuccess()<span class="token punctuation">&quot;</span></span>
        <span class="token punctuation">/&gt;</span></span>
        +
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
          <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>发起ajax失败请求<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sendAjaxError()<span class="token punctuation">&quot;</span></span>
        <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token operator">+</span>        <span class="token keyword">function</span> <span class="token function">sendAjaxSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">+</span>            <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'/success'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">+</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            <span class="token punctuation">}</span>
      <span class="token operator">+</span>            xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>        <span class="token punctuation">}</span>
      <span class="token operator">+</span>        <span class="token keyword">function</span> <span class="token function">sendAjaxError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">+</span>            <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'/error'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">+</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            <span class="token punctuation">}</span>
      <span class="token operator">+</span>            xhr<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">+</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            <span class="token punctuation">}</span>
      <span class="token operator">+</span>            xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;name=zhufeng&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><ol start="2"><li>monitor\index.js
src\monitor\index.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> injectJsError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/jsError'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> injectXHR <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/xhr'</span><span class="token punctuation">;</span>
<span class="token function">injectJsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token function">injectXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="3"><li>webpack.config.js
webpack.config.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    mode<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    entry<span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">{</span>
        path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename<span class="token operator">:</span> <span class="token string">'monitor.js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
        contentBase<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token operator">+</span>        <span class="token function">before</span><span class="token punctuation">(</span><span class="token parameter">router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>            router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/success'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>                res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>                res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    module<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            template<span class="token operator">:</span> <span class="token string">'./src/index.html'</span><span class="token punctuation">,</span>
            inject<span class="token operator">:</span> <span class="token string">'head'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><ol start="4"><li>xhr.js
src\monitor\lib\xhr.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> tracker <span class="token keyword">from</span> <span class="token string">&quot;../util/tracker&quot;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">injectXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> XMLHttpRequest <span class="token operator">=</span> window<span class="token punctuation">.</span>XMLHttpRequest
  <span class="token keyword">let</span> oldOpen <span class="token operator">=</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>open
  <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">open</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
    <span class="token parameter">method<span class="token punctuation">,</span>
    url<span class="token punctuation">,</span>
    async<span class="token punctuation">,</span>
    username<span class="token punctuation">,</span>
    password</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">logstores</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">sockjs</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logData <span class="token operator">=</span> <span class="token punctuation">{</span>
        method<span class="token punctuation">,</span>
        url<span class="token punctuation">,</span>
        async<span class="token punctuation">,</span>
        username<span class="token punctuation">,</span>
        password<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">oldOpen</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> oldSend <span class="token operator">=</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>send
  <span class="token keyword">let</span> start
  <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">send</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">body</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> duration <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start
        <span class="token keyword">let</span> status <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status
        <span class="token keyword">let</span> statusText <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>statusText
        tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token comment">//未捕获的promise错误</span>
          kind<span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span> <span class="token comment">//稳定性指标</span>
          type<span class="token operator">:</span> <span class="token string">&quot;xhr&quot;</span><span class="token punctuation">,</span> <span class="token comment">//xhr</span>
          eventType<span class="token operator">:</span> type<span class="token punctuation">,</span> <span class="token comment">//load error abort</span>
          pathname<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logData<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token comment">//接口的url地址</span>
          status<span class="token operator">:</span> status <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> statusText<span class="token punctuation">,</span>
          duration<span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> duration<span class="token punctuation">,</span> <span class="token comment">//接口耗时</span>
          response<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
          params<span class="token operator">:</span> body <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token string">&quot;load&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;abort&quot;</span><span class="token punctuation">,</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token string">&quot;abort&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">oldSend</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h3 id="_4-4-白屏"><a href="#_4-4-白屏" class="header-anchor">#</a> 4.4 白屏</h3> <p>白屏就是页面上什么都没有</p> <h4 id="_4-4-1-数据设计"><a href="#_4-4-1-数据设计" class="header-anchor">#</a> 4.4.1 数据设计</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590822618759&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chrome&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span>      <span class="token comment">//大类</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;blank&quot;</span><span class="token punctuation">,</span>          <span class="token comment">//小类</span>
  <span class="token string">&quot;emptyPoints&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>       <span class="token comment">//空白点</span>
  <span class="token string">&quot;screen&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2049x1152&quot;</span><span class="token punctuation">,</span>    <span class="token comment">//分辨率</span>
  <span class="token string">&quot;viewPoint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2048x994&quot;</span><span class="token punctuation">,</span>  <span class="token comment">//视口</span>
  <span class="token string">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HTML BODY #container&quot;</span> <span class="token comment">//选择器</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_4-4-2-实现"><a href="#_4-4-2-实现" class="header-anchor">#</a> 4.4.2 实现</h4> <p>screen 返回当前 window 的 screen 对象,返回当前渲染窗口中和屏幕有关的属性
innerWidth 只读的 Window 属性 innerWidth 返回以像素为单位的窗口的内部宽度
innerHeight 窗口的内部高度(布局视口)的高度
layout_viewport
elementsFromPoint 方法可以获取到当前视口内指定坐标处，由里到外排列的所有元素</p> <ol><li>src\index.html</li></ol> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>monitor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">width</span><span class="token punctuation">:</span>600px<span class="token punctuation">;</span><span class="token property">word-wrap</span><span class="token punctuation">:</span>break-word<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token operator">+</span>        <span class="token keyword">let</span> content <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>        content<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'@'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ol start="2"><li>monitor\index.js</li></ol> <p>src\monitor\index.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> injectJsError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/jsError'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> injectXHR <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/xhr'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> blankScreen <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/blankScreen'</span><span class="token punctuation">;</span>
<span class="token function">injectJsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">injectXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token function">blankScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="3"><li>onload.js
src\monitor\util\onload.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">&quot;complete&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="4"><li>blankScreen.js</li></ol> <p>src\monitor\lib\blankScreen.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> tracker <span class="token keyword">from</span> <span class="token string">&quot;../util/tracker&quot;</span>
<span class="token keyword">import</span> onload <span class="token keyword">from</span> <span class="token string">&quot;../util/onload&quot;</span>
<span class="token keyword">function</span> <span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> selector
  <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    selector <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>className <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>className <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    selector <span class="token operator">=</span>
      <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span>
      element<span class="token punctuation">.</span>className
        <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>item
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    selector <span class="token operator">=</span> element<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> selector
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">blankScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> wrapperSelectors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;body&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;html&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;#container&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.content&quot;</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> emptyPoints <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">function</span> <span class="token function">isWrapper</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> selector <span class="token operator">=</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapperSelectors<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      emptyPoints<span class="token operator">++</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">onload</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> xElements<span class="token punctuation">,</span> yElements
    <span class="token keyword">debugger</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      xElements <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">elementsFromPoint</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerWidth <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">,</span>
        window<span class="token punctuation">.</span>innerHeight <span class="token operator">/</span> <span class="token number">2</span>
      <span class="token punctuation">)</span>
      yElements <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">elementsFromPoint</span><span class="token punctuation">(</span>
        window<span class="token punctuation">.</span>innerWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerHeight <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span>
      <span class="token punctuation">)</span>
      <span class="token function">isWrapper</span><span class="token punctuation">(</span>xElements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token function">isWrapper</span><span class="token punctuation">(</span>yElements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyPoints <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> centerElements <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">elementsFromPoint</span><span class="token punctuation">(</span>
        window<span class="token punctuation">.</span>innerWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        window<span class="token punctuation">.</span>innerHeight <span class="token operator">/</span> <span class="token number">2</span>
      <span class="token punctuation">)</span>
      tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        kind<span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span>
        type<span class="token operator">:</span> <span class="token string">&quot;blank&quot;</span><span class="token punctuation">,</span>
        emptyPoints<span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> emptyPoints<span class="token punctuation">,</span>
        screen<span class="token operator">:</span> window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>width <span class="token operator">+</span> <span class="token string">&quot;x&quot;</span> <span class="token operator">+</span> window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
        viewPoint<span class="token operator">:</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">+</span> <span class="token string">&quot;x&quot;</span> <span class="token operator">+</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">,</span>
        selector<span class="token operator">:</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>centerElements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//screen.width  屏幕的宽度   screen.height 屏幕的高度</span>
<span class="token comment">//window.innerWidth 去除工具条与滚动条的窗口宽度 window.innerHeight 去除工具条与滚动条的窗口高度</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><h3 id="_4-5-加载时间"><a href="#_4-5-加载时间" class="header-anchor">#</a> 4.5 加载时间</h3> <p>PerformanceTiming
DOMContentLoaded
FMP</p> <h4 id="_4-5-1-阶段含义"><a href="#_4-5-1-阶段含义" class="header-anchor">#</a> 4.5.1 阶段含义</h4> <p>-|-|-
字段| 含义
navigationStart| 初始化页面，在同一个浏览器上下文中前一个页面 unload 的时间戳，如果没有前一个页面的 unload,则与 fetchStart 值相等
redirectStart| 第一个 HTTP 重定向发生的时间,有跳转且是同域的重定向,否则为 0
redirectEnd| 最后一个重定向完成时的时间,否则为 0
fetchStart| 浏览器准备好使用 http 请求获取文档的时间,这发生在检查缓存之前
domainLookupStart| DNS 域名开始查询的时间,如果有本地的缓存或 keep-alive 则时间为 0
domainLookupEnd| DNS 域名结束查询的时间
connectStart| TCP 开始建立连接的时间,如果是持久连接,则与 fetchStart 值相等
secureConnectionStart| https 连接开始的时间,如果不是安全连接则为 0
connectEnd| TCP 完成握手的时间，如果是持久连接则与 fetchStart 值相等
requestStart| HTTP 请求读取真实文档开始的时间,包括从本地缓存读取
requestEnd| HTTP 请求读取真实文档结束的时间,包括从本地缓存读取
responseStart| 返回浏览器从服务器收到（或从本地缓存读取）第一个字节时的 Unix 毫秒时间戳
responseEnd| 返回浏览器从服务器收到（或从本地缓存读取，或从本地资源读取）最后一个字节时的 Unix 毫秒时间戳
unloadEventStart| 前一个页面的 unload 的时间戳 如果没有则为 0
unloadEventEnd| 与 unloadEventStart 相对应，返回的是 unload 函数执行完成的时间戳
domLoading| 返回当前网页 DOM 结构开始解析时的时间戳,此时 document.readyState 变成 loading,并将抛出 readyStateChange 事件
domInteractive| 返回当前网页 DOM 结构结束解析、开始加载内嵌资源时时间戳,document.readyState 变成 interactive，并将抛出 readyStateChange 事件(注意只是 DOM 树解析完成,这时候并没有开始加载网页内的资源)
domContentLoadedEventStart| 网页 domContentLoaded 事件发生的时间
domContentLoadedEventEnd| 网页 domContentLoaded 事件脚本执行完毕的时间,domReady 的时间
domComplete| DOM 树解析完成,且资源也准备就绪的时间,document.readyState 变成 complete.并将抛出 readystatechange 事件
loadEventStart| load 事件发送给文档，也即 load 回调函数开始执行的时间
loadEventEnd| load 回调函数执行完成的时间</p> <h4 id="_4-5-2-阶段计算"><a href="#_4-5-2-阶段计算" class="header-anchor">#</a> 4.5.2 阶段计算</h4> <p>|-|-|-|-|
字段| 描述| 计算方式| 意义
unload| 前一个页面卸载耗时| unloadEventEnd| – unloadEventStart -
redirect| 重定向耗时| redirectEnd – redirectStart| 重定向的时间
appCache| 缓存耗时| domainLookupStart – fetchStart| 读取缓存的时间
dns| DNS 解析耗时| domainLookupEnd – domainLookupStart| 可观察域名解析服务是否正常
tcp| TCP 连接耗时| connectEnd – connectStart| 建立连接的耗时
ssl| SSL 安全连接耗时| connectEnd – secureConnectionStart| 反映数据安全连接建立耗时
ttfb| Time to First Byte(TTFB)网络请求耗时| responseStart – requestStart| TTFB 是发出页面请求到接收到应答数据第一个字节所花费的毫秒数
response| 响应数据传输耗时| responseEnd – responseStart| 观察网络是否正常
dom| DOM 解析耗时| domInteractive – responseEnd| 观察 DOM 结构是否合理，是否有 JS 阻塞页面解析
dcl| DOMContentLoaded 事件耗时| domContentLoadedEventEnd – domContentLoadedEventStart| 当 HTML 文档被完全加载和解析完成之后，DOMContentLoaded 事件被触发，无需等待样式表、图像和子框架的完成加载
resources| 资源加载耗时| domComplete – domContentLoadedEventEnd| 可观察文档流是否过大
domReady| DOM 阶段渲染耗时| domContentLoadedEventEnd – fetchStart DOM 树和页面资源加载完成时间，会触发 domContentLoaded 事件
首次渲染耗时| 首次渲染耗时| responseEnd-fetchStart| 加载文档到看到第一帧非空图像的时间，也叫白屏时间
首次可交互时间| 首次可交互时间| domInteractive-fetchStart| DOM 树解析完成时间，此时 document.readyState 为 interactive
首包时间耗时| 首包时间| responseStart-domainLookupStart| DNS 解析到响应返回给浏览器第一个字节的时间
页面完全加载时间| 页面完全加载时间| loadEventStart - fetchStart -
onLoad| onLoad 事件耗时| loadEventEnd – loadEventStart
renderscope3</p> <p>browerrender</p> <h4 id="_4-5-3-数据结构"><a href="#_4-5-3-数据结构" class="header-anchor">#</a> 4.5.3 数据结构</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590828364183&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chrome&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;experience&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;timing&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;connectTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;ttfbTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;responseTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;parseDOMTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;80&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;domContentLoadedTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;timeToInteractive&quot;</span><span class="token operator">:</span> <span class="token string">&quot;88&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;loadTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;89&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="_4-5-4-实现"><a href="#_4-5-4-实现" class="header-anchor">#</a> 4.5.4 实现</h4> <ol><li>src\index.html
src\index.html</li></ol> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>monitor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">width</span><span class="token punctuation">:</span>600px<span class="token punctuation">;</span><span class="token property">word-wrap</span><span class="token punctuation">:</span>break-word<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
              <span class="token keyword">let</span> content <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
              <span class="token comment">//content.innerHTML = '@'.repeat(10000);</span>
              document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">+</span>            <span class="token keyword">let</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token operator">+</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ol start="2"><li>monitor\index.js
src\monitor\index.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> injectJsError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/jsError'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> injectXHR <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/xhr'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> blankScreen <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/blankScreen'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> timing <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/timing'</span><span class="token punctuation">;</span>
<span class="token function">injectJsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">injectXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">blankScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token function">timing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">3.</span> timing<span class="token punctuation">.</span>js
src\monitor\lib\timing<span class="token punctuation">.</span>js

<span class="token keyword">import</span> onload <span class="token keyword">from</span> <span class="token string">'../util/onload'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> tracker <span class="token keyword">from</span> <span class="token string">'../util/tracker'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> formatTime <span class="token keyword">from</span> <span class="token string">'../util/formatTime'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getLastEvent <span class="token keyword">from</span> <span class="token string">'../util/getLastEvent'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getSelector <span class="token keyword">from</span> <span class="token string">'../util/getSelector'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">timing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onload</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span>
                fetchStart<span class="token punctuation">,</span>
                connectStart<span class="token punctuation">,</span>
                connectEnd<span class="token punctuation">,</span>
                requestStart<span class="token punctuation">,</span>
                responseStart<span class="token punctuation">,</span>
                responseEnd<span class="token punctuation">,</span>
                domLoading<span class="token punctuation">,</span>
                domInteractive<span class="token punctuation">,</span>
                domContentLoadedEventStart<span class="token punctuation">,</span>
                domContentLoadedEventEnd<span class="token punctuation">,</span>
                loadEventStart <span class="token punctuation">}</span> <span class="token operator">=</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">;</span>
            tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                kind<span class="token operator">:</span> <span class="token string">'experience'</span><span class="token punctuation">,</span>
                type<span class="token operator">:</span> <span class="token string">'timing'</span><span class="token punctuation">,</span>
                connectTime<span class="token operator">:</span> connectEnd <span class="token operator">-</span> connectStart<span class="token punctuation">,</span><span class="token comment">//TCP连接耗时</span>
                ttfbTime<span class="token operator">:</span> responseStart <span class="token operator">-</span> requestStart<span class="token punctuation">,</span><span class="token comment">//ttfb</span>
                responseTime<span class="token operator">:</span> responseEnd <span class="token operator">-</span> responseStart<span class="token punctuation">,</span><span class="token comment">//Response响应耗时</span>
                parseDOMTime<span class="token operator">:</span> loadEventStart <span class="token operator">-</span> domLoading<span class="token punctuation">,</span><span class="token comment">//DOM解析渲染耗时</span>
                domContentLoadedTime<span class="token operator">:</span> domContentLoadedEventEnd <span class="token operator">-</span> domContentLoadedEventStart<span class="token punctuation">,</span><span class="token comment">//DOMContentLoaded事件回调耗时</span>
                timeToInteractive<span class="token operator">:</span> domInteractive <span class="token operator">-</span> fetchStart<span class="token punctuation">,</span><span class="token comment">//首次可交互时间</span>
                loadTime<span class="token operator">:</span> loadEventStart <span class="token operator">-</span> fetchStart<span class="token comment">//完整的加载时间</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h3 id="_4-6-性能指标"><a href="#_4-6-性能指标" class="header-anchor">#</a> 4.6 性能指标</h3> <p>PerformanceObserver.observe 方法用于观察传入的参数中指定的性能条目类型的集合。当记录一个指定类型的性能条目时，性能监测对象的回调函数将会被调用
entryType
paint-timing
event-timing
LCP
FMP
time-to-interactive
字段 描述 备注 计算方式
FP First Paint(首次绘制) 包括了任何用户自定义的背景绘制，它是首先将像素绘制到屏幕的时刻
FCP First Content Paint(首次内容绘制) 是浏览器将第一个 DOM 渲染到屏幕的时间,可能是文本、图像、SVG 等,这其实就是白屏时间
FMP First Meaningful Paint(首次有意义绘制) 页面有意义的内容渲染的时间
LCP (Largest Contentful Paint)(最大内容渲染) 代表在 viewport 中最大的页面元素加载的时间
DCL (DomContentLoaded)(DOM 加载完成) 当 HTML 文档被完全加载和解析完成之后,DOMContentLoaded 事件被触发，无需等待样式表、图像和子框架的完成加载
L (onLoad) 当依赖的资源全部加载完毕之后才会触发
TTI (Time to Interactive) 可交互时间 用于标记应用已进行视觉渲染并能可靠响应用户输入的时间点
FID First Input Delay(首次输入延迟) 用户首次和页面交互(单击链接，点击按钮等)到页面响应交互的时间
baidurender</p> <p>lcp</p> <h4 id="_4-6-1-数据结构设计"><a href="#_4-6-1-数据结构设计" class="header-anchor">#</a> 4.6.1 数据结构设计</h4> <ol><li>paint</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590828364186&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chrome&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;experience&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;paint&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;firstPaint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;102&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;firstContentPaint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2130&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;firstMeaningfulPaint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2130&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;largestContentfulPaint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2130&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol start="2"><li>firstInputDelay</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590828477284&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chrome&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;experience&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;firstInputDelay&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;inputDelay&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;duration&quot;</span><span class="token operator">:</span> <span class="token string">&quot;8&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;startTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4812.344999983907&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HTML BODY #container .content H1&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_4-6-2-实现"><a href="#_4-6-2-实现" class="header-anchor">#</a> 4.6.2 实现</h4> <ol><li>src\index.html
src\index.html</li></ol> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>monitor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">background-color</span><span class="token punctuation">:</span> green<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>
        <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span>
        <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">width</span><span class="token punctuation">:</span>600px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>600px<span class="token punctuation">;</span><span class="token property">word-wrap</span><span class="token punctuation">:</span>break-word<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span>
      <span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
              <span class="token keyword">let</span> content <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
              <span class="token comment">//content.innerHTML = '@'.repeat(10000);</span>
      <span class="token operator">+</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token operator">+</span>            <span class="token keyword">let</span> h1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            h1<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'我是最有重要的内容'</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            h1<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'elementtiming'</span><span class="token punctuation">,</span> <span class="token string">'meaningful'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            content<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>h1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><ol start="2"><li>timing.js
src\monitor\lib\timing.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> onload <span class="token keyword">from</span> <span class="token string">'../util/onload'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> tracker <span class="token keyword">from</span> <span class="token string">'../util/tracker'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> formatTime <span class="token keyword">from</span> <span class="token string">'../util/formatTime'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getLastEvent <span class="token keyword">from</span> <span class="token string">'../util/getLastEvent'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getSelector <span class="token keyword">from</span> <span class="token string">'../util/getSelector'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">timing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    <span class="token keyword">let</span> <span class="token constant">FMP</span><span class="token punctuation">,</span> <span class="token constant">LCP</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entryList<span class="token punctuation">,</span> observer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>        <span class="token keyword">let</span> perfEntries <span class="token operator">=</span> entryList<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token constant">FMP</span> <span class="token operator">=</span> perfEntries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> entryTypes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'element'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">+</span>    <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entryList<span class="token punctuation">,</span> observer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>        <span class="token keyword">const</span> perfEntries <span class="token operator">=</span> entryList<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">const</span> lastEntry <span class="token operator">=</span> perfEntries<span class="token punctuation">[</span>perfEntries<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token constant">LCP</span> <span class="token operator">=</span> lastEntry<span class="token punctuation">;</span>
<span class="token operator">+</span>        observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> entryTypes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'largest-contentful-paint'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">+</span>    <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">entryList<span class="token punctuation">,</span> observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>        <span class="token keyword">let</span> lastEvent <span class="token operator">=</span> <span class="token function">getLastEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">const</span> firstInput <span class="token operator">=</span> entryList<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstInput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>            <span class="token keyword">let</span> inputDelay <span class="token operator">=</span> firstInput<span class="token punctuation">.</span>processingStart <span class="token operator">-</span> firstInput<span class="token punctuation">.</span>startTime<span class="token punctuation">;</span><span class="token comment">//处理延迟</span>
<span class="token operator">+</span>            <span class="token keyword">let</span> duration <span class="token operator">=</span> firstInput<span class="token punctuation">.</span>duration<span class="token punctuation">;</span><span class="token comment">//处理耗时</span>
<span class="token operator">+</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstInput <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> duration <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>                tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
<span class="token operator">+</span>                    kind<span class="token operator">:</span> <span class="token string">'experience'</span><span class="token punctuation">,</span>
<span class="token operator">+</span>                    type<span class="token operator">:</span> <span class="token string">'firstInputDelay'</span><span class="token punctuation">,</span>
<span class="token operator">+</span>                    inputDelay<span class="token operator">:</span> inputDelay <span class="token operator">?</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>inputDelay<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token operator">+</span>                    duration<span class="token operator">:</span> duration <span class="token operator">?</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token operator">+</span>                    startTime<span class="token operator">:</span> firstInput<span class="token punctuation">.</span>startTime<span class="token punctuation">,</span>
<span class="token operator">+</span>                    selector<span class="token operator">:</span> lastEvent <span class="token operator">?</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>lastEvent<span class="token punctuation">.</span>path <span class="token operator">||</span> lastEvent<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span>
<span class="token operator">+</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token punctuation">}</span>
<span class="token operator">+</span>        <span class="token punctuation">}</span>
<span class="token operator">+</span>        observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'first-input'</span><span class="token punctuation">,</span> buffered<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">onload</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span>
                fetchStart<span class="token punctuation">,</span>
                connectStart<span class="token punctuation">,</span>
                connectEnd<span class="token punctuation">,</span>
                requestStart<span class="token punctuation">,</span>
                responseStart<span class="token punctuation">,</span>
                responseEnd<span class="token punctuation">,</span>
                domLoading<span class="token punctuation">,</span>
                domInteractive<span class="token punctuation">,</span>
                domContentLoadedEventStart<span class="token punctuation">,</span>
                domContentLoadedEventEnd<span class="token punctuation">,</span>
                loadEventStart <span class="token punctuation">}</span> <span class="token operator">=</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">;</span>
            tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                kind<span class="token operator">:</span> <span class="token string">'experience'</span><span class="token punctuation">,</span>
                type<span class="token operator">:</span> <span class="token string">'timing'</span><span class="token punctuation">,</span>
                connectTime<span class="token operator">:</span> connectEnd <span class="token operator">-</span> connectStart<span class="token punctuation">,</span><span class="token comment">//TCP连接耗时</span>
                ttfbTime<span class="token operator">:</span> responseStart <span class="token operator">-</span> requestStart<span class="token punctuation">,</span><span class="token comment">//ttfb</span>
                responseTime<span class="token operator">:</span> responseEnd <span class="token operator">-</span> responseStart<span class="token punctuation">,</span><span class="token comment">//Response响应耗时</span>
                parseDOMTime<span class="token operator">:</span> loadEventStart <span class="token operator">-</span> domLoading<span class="token punctuation">,</span><span class="token comment">//DOM解析渲染耗时</span>
                domContentLoadedTime<span class="token operator">:</span> domContentLoadedEventEnd <span class="token operator">-</span> domContentLoadedEventStart<span class="token punctuation">,</span><span class="token comment">//DOMContentLoaded事件回调耗时</span>
                timeToInteractive<span class="token operator">:</span> domInteractive <span class="token operator">-</span> fetchStart<span class="token punctuation">,</span><span class="token comment">//首次可交互时间</span>
                loadTime<span class="token operator">:</span> loadEventStart <span class="token operator">-</span> fetchStart<span class="token comment">//完整的加载时间</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token keyword">const</span> <span class="token constant">FP</span> <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">getEntriesByName</span><span class="token punctuation">(</span><span class="token string">'first-paint'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token keyword">const</span> <span class="token constant">FCP</span> <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">getEntriesByName</span><span class="token punctuation">(</span><span class="token string">'first-contentful-paint'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FP'</span><span class="token punctuation">,</span> <span class="token constant">FP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FCP'</span><span class="token punctuation">,</span> <span class="token constant">FCP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FMP'</span><span class="token punctuation">,</span> <span class="token constant">FMP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LCP'</span><span class="token punctuation">,</span> <span class="token constant">LCP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
<span class="token operator">+</span>                kind<span class="token operator">:</span> <span class="token string">'experience'</span><span class="token punctuation">,</span>
<span class="token operator">+</span>                type<span class="token operator">:</span> <span class="token string">'paint'</span><span class="token punctuation">,</span>
<span class="token operator">+</span>                firstPaint<span class="token operator">:</span> <span class="token constant">FP</span> <span class="token operator">?</span> <span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token constant">FP</span><span class="token punctuation">.</span>startTime<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token operator">+</span>                firstContentPaint<span class="token operator">:</span> <span class="token constant">FCP</span> <span class="token operator">?</span> <span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token constant">FCP</span><span class="token punctuation">.</span>startTime<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token operator">+</span>                firstMeaningfulPaint<span class="token operator">:</span> <span class="token constant">FMP</span> <span class="token operator">?</span> <span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token constant">FMP</span><span class="token punctuation">.</span>startTime<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token operator">+</span>                largestContentfulPaint<span class="token operator">:</span> <span class="token constant">LCP</span> <span class="token operator">?</span> <span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token constant">LCP</span><span class="token punctuation">.</span>renderTime <span class="token operator">||</span> <span class="token constant">LCP</span><span class="token punctuation">.</span>loadTime<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span>
<span class="token operator">+</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><h3 id="_4-7-卡顿"><a href="#_4-7-卡顿" class="header-anchor">#</a> 4.7 卡顿</h3> <p>响应用户交互的响应时间如果大于 100ms,用户就会感觉卡顿</p> <h4 id="_4-7-1-数据设计"><a href="#_4-7-1-数据设计" class="header-anchor">#</a> 4.7.1 数据设计</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590828656781&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chrome&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;experience&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;longTask&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;eventType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mouseover&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;startTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;9331&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;duration&quot;</span><span class="token operator">:</span> <span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HTML BODY #container .content&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_4-7-2-实现"><a href="#_4-7-2-实现" class="header-anchor">#</a> 4.7.2 实现</h4> <ol><li>src\index.html</li></ol> <p>src\index.html</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>monitor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">background-color</span><span class="token punctuation">:</span> green<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>
        <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span>
        <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">width</span><span class="token punctuation">:</span>600px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>600px<span class="token punctuation">;</span><span class="token property">word-wrap</span><span class="token punctuation">:</span>break-word<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span>
      <span class="token punctuation">&gt;</span></span>
        + <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>longTaskBtn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>执行longTask<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
              <span class="token keyword">let</span> content <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>        <span class="token keyword">let</span> longTaskBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'longTaskBtn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>        longTaskBtn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> longTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>        <span class="token keyword">function</span> <span class="token function">longTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">+</span>            <span class="token keyword">let</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'longTask开始 start'</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">200</span> <span class="token operator">+</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
      <span class="token operator">+</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'longTask结束 end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span>        <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ol start="2"><li>monitor\index.js</li></ol> <p>src\monitor\index.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> injectJsError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/jsError'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> injectXHR <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/xhr'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> blankScreen <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/blankScreen'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> timing <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/timing'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> longTask <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/longTask'</span><span class="token punctuation">;</span>
<span class="token function">injectJsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">injectXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">blankScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">timing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token function">longTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">3.</span> longTask<span class="token punctuation">.</span>js
src\monitor\lib\longTask<span class="token punctuation">.</span>js

<span class="token keyword">import</span> tracker <span class="token keyword">from</span> <span class="token string">'../util/tracker'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> formatTime <span class="token keyword">from</span> <span class="token string">'../util/formatTime'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getLastEvent <span class="token keyword">from</span> <span class="token string">'../util/getLastEvent'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getSelector <span class="token keyword">from</span> <span class="token string">'../util/getSelector'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">longTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">entry</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>duration <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> lastEvent <span class="token operator">=</span> <span class="token function">getLastEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        kind<span class="token operator">:</span> <span class="token string">'experience'</span><span class="token punctuation">,</span>
                        type<span class="token operator">:</span> <span class="token string">'longTask'</span><span class="token punctuation">,</span>
                        eventType<span class="token operator">:</span> lastEvent<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
                        startTime<span class="token operator">:</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>startTime<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 开始时间</span>
                        duration<span class="token operator">:</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>duration<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 持续时间</span>
                        selector<span class="token operator">:</span> lastEvent <span class="token operator">?</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>lastEvent<span class="token punctuation">.</span>path <span class="token operator">||</span> lastEvent<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> entryTypes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;longtask&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h3 id="_4-8-pv"><a href="#_4-8-pv" class="header-anchor">#</a> 4.8 pv</h3> <p>netinfo</p> <p>RTT(Round Trip Time)一个连接的往返时间，即数据发送时刻到接收到确认的时刻的差值</p> <p>navigator.sendBeacon() 方法可用于通过 HTTP 将少量数据异步传输到 Web 服务器。</p> <p>rtttime2</p> <h4 id="_4-8-1-数据结构"><a href="#_4-8-1-数据结构" class="header-anchor">#</a> 4.8.1 数据结构</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590829304423&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chrome&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;business&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pv&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;effectiveType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4g&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;rtt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;50&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;screen&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2049x1152&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_4-8-2-实现"><a href="#_4-8-2-实现" class="header-anchor">#</a> 4.8.2 实现</h4> <ol><li>src\index.html
src\index.html</li></ol> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>前端监控SDK<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li>src\monitor\index.js
src\monitor\index.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> injectJsError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/jsError'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> injectXHR <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/xhr'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> blankScreen <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/blankScreen'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> timing <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/timing'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> longTask <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/longTask'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> pv <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/pv'</span><span class="token punctuation">;</span>
<span class="token function">injectJsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">injectXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">blankScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">timing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">longTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token function">pv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol start="3"><li>pv.js
src\monitor\lib\pv.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> tracker <span class="token keyword">from</span> <span class="token string">&quot;../util/tracker&quot;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> connection <span class="token operator">=</span> navigator<span class="token punctuation">.</span>connection
  tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    kind<span class="token operator">:</span> <span class="token string">&quot;business&quot;</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token string">&quot;pv&quot;</span><span class="token punctuation">,</span>
    effectiveType<span class="token operator">:</span> connection<span class="token punctuation">.</span>effectiveType<span class="token punctuation">,</span> <span class="token comment">//网络环境</span>
    rtt<span class="token operator">:</span> connection<span class="token punctuation">.</span>rtt<span class="token punctuation">,</span> <span class="token comment">//往返时间</span>
    screen<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>width<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">x</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>height<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">//设备分辨率</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
    <span class="token string">&quot;unload&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> stayTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime
      tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        kind<span class="token operator">:</span> <span class="token string">&quot;business&quot;</span><span class="token punctuation">,</span>
        type<span class="token operator">:</span> <span class="token string">&quot;stayTime&quot;</span><span class="token punctuation">,</span>
        stayTime<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><ul><li>5.查询报表
图表说明
查询日志数据
聚类分析
数据可视化
趋势 柱状图、拆线图、曲线图
比例 饼图、环状图、面积图
仪表盘
5.1 监控项分布</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">*</span> <span class="token operator">|</span> <span class="token constant">SELECT</span> type<span class="token punctuation">,</span> <span class="token constant">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> number <span class="token constant">GROUP</span> <span class="token constant">BY</span> type <span class="token constant">LIMIT</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>5.2 浏览器分布</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">*</span> <span class="token operator">|</span> <span class="token constant">SELECT</span> userAgent<span class="token punctuation">,</span> <span class="token constant">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> number <span class="token constant">GROUP</span> <span class="token constant">BY</span> userAgent <span class="token constant">LIMIT</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>5.3 页面分辨率分布</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">*</span> <span class="token operator">|</span> <span class="token constant">SELECT</span> screen<span class="token punctuation">,</span> <span class="token constant">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> number <span class="token constant">GROUP</span> <span class="token constant">BY</span> screen <span class="token constant">LIMIT</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_6-参考"><a href="#_6-参考" class="header-anchor">#</a> 6.参考</h2> <h3 id="_6-1-第三方"><a href="#_6-1-第三方" class="header-anchor">#</a> 6.1 第三方</h3> <h4 id="_6-1-1-商业产品"><a href="#_6-1-1-商业产品" class="header-anchor">#</a> 6.1.1 商业产品</h4> <p>神策数据
GrowingIO</p> <h4 id="_6-1-2-开源产品"><a href="#_6-1-2-开源产品" class="header-anchor">#</a> 6.1.2 开源产品</h4> <p>fundebug
BetterJS
Sentry
@sentry/browser</p> <h3 id="_6-2-defer-和-async"><a href="#_6-2-defer-和-async" class="header-anchor">#</a> 6.2 defer 和 async</h3> <p>defer 异步下载 JavaScript 文件,会在 HTML 解析完成之后 DOMContentLoaded 事件调用前执行,不会阻塞页面渲染
如果 script 标签设置了该属性，则浏览器会异步的下载该文件并且不会影响到后续 DOM 的渲染
如果有多个设置了 defer 的 script 标签存在，则会按照顺序执行所有的 script
defer 脚本会在文档渲染完毕后，DOMContentLoaded 事件调用前执行
async 异步下载 JavaScript 文件，下载完成之后会立即执行，有可能会阻塞页面渲染
async 的设置,会使得 script 脚本异步的加载并在允许的情况下执行
async 的执行,并不会按着 script 在页面中的顺序来执行，而是谁先加载完谁执行</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2021/5/16 下午9:35:54</span></div></div> <!----> </div> <!----></div></div>
    <script src="/Web-Node/assets/js/app.3f8e6221.js" defer></script><script src="/Web-Node/assets/js/136.d1ddb140.js" defer></script>
  </body>
</html>
